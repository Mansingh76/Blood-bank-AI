"""
Machine Learning - KMeans Clustering for Blood Bank Dataset
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import silhouette_score, davies_bouldin_score
import plotly.express as px

def load_data(file_path='data/cleaned_blood_banks.csv'):
    """Load cleaned dataset"""
    return pd.read_csv(file_path)

def prepare_features(df):
    """Prepare features for clustering"""
    # Use latitude and longitude for geographic clustering
    X = df[['latitude', 'longitude']].values
    return X

def elbow_method(X, max_k=10):
    """Determine optimal number of clusters using elbow method"""
    inertias = []
    silhouette_scores = []
    K_range = range(2, max_k + 1)
    
    for k in K_range:
        kmeans = KMeans(n_clusters=k, random_state=42, n_init=10)
        kmeans.fit(X)
        inertias.append(kmeans.inertia_)
        silhouette_scores.append(silhouette_score(X, kmeans.labels_))
    
    # Plot elbow curve
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 5))
    
    ax1.plot(K_range, inertias, 'bo-', linewidth=2)
    ax1.set_xlabel('Number of Clusters (k)', fontsize=12)
    ax1.set_ylabel('Inertia', fontsize=12)
    ax1.set_title('Elbow Method', fontsize=14, fontweight='bold')
    ax1.grid(True)
    
    ax2.plot(K_range, silhouette_scores, 'ro-', linewidth=2)
    ax2.set_xlabel('Number of Clusters (k)', fontsize=12)
    ax2.set_ylabel('Silhouette Score', fontsize=12)
    ax2.set_title('Silhouette Analysis', fontsize=14, fontweight='bold')
    ax2.grid(True)
    
    plt.tight_layout()
    plt.savefig('plots/elbow_method.png', dpi=300)
    plt.show()
    
    return inertias, silhouette_scores

def perform_clustering(df, n_clusters=5):
    """Perform KMeans clustering"""
    X = prepare_features(df)
    
    # Train KMeans
    print(f"Training KMeans with {n_clusters} clusters...")
    kmeans = KMeans(n_clusters=n_clusters, random_state=42, n_init=10)
    df['cluster'] = kmeans.fit_predict(X)
    
    # Calculate metrics
    silhouette = silhouette_score(X, df['cluster'])
    davies_bouldin = davies_bouldin_score(X, df['cluster'])
    
    print(f"\n‚úÖ Clustering Complete!")
    print(f"Silhouette Score: {silhouette:.3f}")
    print(f"Davies-Bouldin Index: {davies_bouldin:.3f}")
    
    return df, kmeans

def visualize_clusters(df):
    """Visualize clusters"""
    # Matplotlib scatter plot
    plt.figure(figsize=(14, 8))
    scatter = plt.scatter(
        df['longitude'],
        df['latitude'],
        c=df['cluster'],
        cmap='viridis',
        s=50,
        alpha=0.6,
        edgecolors='black'
    )
    plt.colorbar(scatter, label='Cluster')
    plt.xlabel('Longitude', fontsize=12)
    plt.ylabel('Latitude', fontsize=12)
    plt.title('Blood Bank Clusters (Geographic)', fontsize=16, fontweight='bold')
    plt.grid(True, alpha=0.3)
    plt.tight_layout()
    plt.savefig('plots/clusters_scatter.png', dpi=300)
    plt.show()
    
    # Interactive Plotly map
    fig = px.scatter_geo(
        df,
        lat='latitude',
        lon='longitude',
        color='cluster',
        hover_name='name',
        hover_data=['city', 'state'],
        title='Blood Bank Clusters - Interactive Map',
        color_continuous_scale='Viridis'
    )
    
    fig.update_geos(
        scope='asia',
        showcountries=True,
        countrycolor="lightgray"
    )
    
    fig.update_layout(height=700)
    fig.write_html('plots/clusters_map.html')
    fig.show()

def cluster_analysis(df):
    """Analyze cluster characteristics"""
    print("\n" + "=" * 60)
    print("CLUSTER ANALYSIS")
    print("=" * 60)
    
    for cluster_id in sorted(df['cluster'].unique()):
        cluster_data = df[df['cluster'] == cluster_id]
        print(f"\nüìç Cluster {cluster_id}:")
        print(f"   - Size: {len(cluster_data)} blood banks")
        print(f"   - Top States: {cluster_data['state'].value_counts().head(3).to_dict()}")
        print(f"   - Geographic Center: ({cluster_data['latitude'].mean():.2f}, {cluster_data['longitude'].mean():.2f})")
    
    # Cluster size distribution
    plt.figure(figsize=(10, 6))
    cluster_counts = df['cluster'].value_counts().sort_index()
    cluster_counts.plot(kind='bar', color='steelblue')
    plt.title('Cluster Size Distribution', fontsize=16, fontweight='bold')
    plt.xlabel('Cluster', fontsize=12)
    plt.ylabel('Number of Blood Banks', fontsize=12)
    plt.xticks(rotation=0)
    plt.tight_layout()
    plt.savefig('plots/cluster_sizes.png', dpi=300)
    plt.show()

def save_clustered_data(df, output_path='data/clustered_blood_banks.csv'):
    """Save dataset with cluster labels"""
    df.to_csv(output_path, index=False)
    print(f"\n‚úÖ Clustered data saved to: {output_path}")

def run_full_clustering():
    """Run complete clustering pipeline"""
    import os
    os.makedirs('plots', exist_ok=True)
    
    print("Loading data...")
    df = load_data()
    
    print("\n1. Preparing Features...")
    X = prepare_features(df)
    
    print("\n2. Running Elbow Method...")
    elbow_method(X)
    
    print("\n3. Performing Clustering...")
    df_clustered, kmeans = perform_clustering(df, n_clusters=5)
    
    print("\n4. Visualizing Clusters...")
    visualize_clusters(df_clustered)
    
    print("\n5. Analyzing Clusters...")
    cluster_analysis(df_clustered)
    
    print("\n6. Saving Results...")
    save_clustered_data(df_clustered)
    
    print("\n‚úÖ Clustering Complete! Check the 'plots' folder for visualizations.")

if __name__ == "__main__":
    run_full_clustering()
